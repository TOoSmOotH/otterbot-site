<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Architecture â€” OtterBot Docs</title>
<meta name="description" content="OtterBot system architecture: agent hierarchy, message bus, workspace isolation, and monorepo layout.">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=IBM+Plex+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --navy: #0a1628;
  --navy-light: #0f2240;
  --navy-mid: #132d54;
  --cyan: #00d4ff;
  --cyan-glow: #00d4ff55;
  --cyan-dim: #00d4ff22;
  --teal: #0891b2;
  --green: #4a7c59;
  --green-light: #5fa872;
  --white: #e8f4f8;
  --foam: #c8e6ec;
  --grey: #7b9eb8;
  --sidebar-w: 260px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { background: var(--navy); font-family: 'IBM Plex Sans', sans-serif; color: var(--foam); }
::selection { background: #00d4ff33; color: var(--white); }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: var(--navy); }
::-webkit-scrollbar-thumb { background: #00d4ff33; border-radius: 3px; }

.sidebar {
  position: fixed; top: 0; left: 0; bottom: 0;
  width: var(--sidebar-w); background: var(--navy-light);
  border-right: 1px solid #00d4ff12;
  padding: 24px 0; overflow-y: auto; z-index: 100;
  display: flex; flex-direction: column;
}
.sidebar-brand {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px; font-weight: 800; color: var(--white);
  padding: 0 24px 20px; border-bottom: 1px solid #00d4ff10;
  margin-bottom: 16px; text-decoration: none; display: block;
}
.sidebar-brand .cyan { color: var(--cyan); }
.sidebar-brand .sub {
  display: block; font-size: 11px; font-weight: 500;
  color: var(--grey); margin-top: 4px; letter-spacing: 0.05em;
}
.sidebar-section {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px; font-weight: 600; color: var(--grey);
  letter-spacing: 0.12em; text-transform: uppercase; padding: 16px 24px 8px;
}
.sidebar-link {
  display: block; padding: 8px 24px; font-size: 14px; font-weight: 500;
  color: var(--grey); text-decoration: none;
  transition: all 0.15s; border-left: 2px solid transparent;
}
.sidebar-link:hover { color: var(--cyan); background: #00d4ff08; }
.sidebar-link.active { color: var(--cyan); background: #00d4ff10; border-left-color: var(--cyan); }
.sidebar-back {
  display: flex; align-items: center; gap: 6px;
  padding: 8px 24px; margin-bottom: 8px;
  font-size: 13px; color: var(--grey);
  text-decoration: none; transition: color 0.15s;
}
.sidebar-back:hover { color: var(--cyan); }
.sidebar-footer {
  margin-top: auto; padding: 16px 24px; border-top: 1px solid #00d4ff10;
}
.sidebar-footer a {
  font-size: 12px; color: var(--grey); text-decoration: none;
  display: flex; align-items: center; gap: 6px;
}
.sidebar-footer a:hover { color: var(--cyan); }

.mobile-toggle {
  display: none; position: fixed; top: 16px; left: 16px; z-index: 200;
  background: var(--navy-light); border: 1px solid #00d4ff20;
  border-radius: 8px; padding: 8px 12px; cursor: pointer;
  color: var(--cyan); font-size: 20px;
}

.main {
  margin-left: var(--sidebar-w);
  min-height: 100vh; padding: 48px 60px 80px;
  max-width: calc(var(--sidebar-w) + 900px);
}

h1 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 32px; font-weight: 800; color: var(--white);
  letter-spacing: -0.03em; margin-bottom: 8px;
}
h1 .cyan { color: var(--cyan); }
.page-desc {
  font-size: 16px; color: var(--grey); line-height: 1.7;
  margin-bottom: 40px; max-width: 600px;
}
h2 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 22px; font-weight: 700; color: var(--white);
  letter-spacing: -0.02em; margin: 48px 0 16px;
  padding-bottom: 8px; border-bottom: 1px solid #00d4ff10;
}
h2 .cyan { color: var(--cyan); }
h3 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 16px; font-weight: 600; color: var(--cyan);
  margin: 28px 0 12px;
}
p, li {
  font-size: 15px; line-height: 1.7; color: var(--grey);
  margin-bottom: 12px; max-width: 700px;
}
ul { padding-left: 20px; margin-bottom: 16px; }
li { margin-bottom: 6px; }
a { color: var(--cyan); }
code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px; background: #0f224088;
  padding: 2px 6px; border-radius: 4px; color: var(--cyan);
}

.code-block {
  background: var(--navy);
  border: 1px solid #00d4ff20;
  border-radius: 12px; padding: 20px 24px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px; line-height: 1.7; color: var(--foam);
  overflow-x: auto; margin: 16px 0 24px;
  white-space: pre;
}
.code-block .kw { color: #c792ea; }
.code-block .str { color: #c3e88d; }
.code-block .fl { color: var(--cyan); }
.code-block .cm { color: #546e7a; }

.callout {
  margin: 20px 0; padding: 16px 20px;
  border-radius: 10px; display: flex;
  align-items: flex-start; gap: 12px;
}
.callout.info { background: #0891b215; border: 1px solid #0891b230; }
.callout p { margin: 0; font-size: 14px; }
.callout strong { color: var(--foam); }
.callout .icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }

/* DIAGRAM */
.diagram {
  background: var(--navy);
  border: 1px solid #00d4ff20;
  border-radius: 14px; padding: 28px 32px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px; line-height: 1.6; color: var(--foam);
  overflow-x: auto; margin: 16px 0 24px;
  white-space: pre;
}
.diagram .role { color: var(--cyan); font-weight: 700; }
.diagram .arrow { color: var(--grey); }
.diagram .note { color: #546e7a; }

.on-page {
  background: #0f224066; border: 1px solid #00d4ff10;
  border-radius: 12px; padding: 20px 24px; margin-bottom: 32px;
}
.on-page-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; font-weight: 600; color: var(--grey);
  letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 10px;
}
.on-page a {
  display: block; font-size: 14px; color: var(--grey);
  text-decoration: none; padding: 4px 0; transition: color 0.15s;
}
.on-page a:hover { color: var(--cyan); }

/* PACKAGE CARDS */
.pkg-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 14px; margin: 16px 0 24px;
}
.pkg-card {
  background: linear-gradient(135deg, #0f2240cc, #132d5466);
  border: 1px solid #00d4ff15; border-radius: 12px;
  padding: 20px;
}
.pkg-card h4 {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px; font-weight: 700; color: var(--cyan);
  margin-bottom: 6px;
}
.pkg-card .path {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; color: var(--grey); margin-bottom: 8px;
  opacity: 0.7;
}
.pkg-card p {
  font-size: 13px; line-height: 1.5; margin: 0;
}

/* TECH STACK */
.table-wrap { overflow-x: auto; margin: 16px 0 24px; }
table { width: 100%; border-collapse: collapse; font-size: 13.5px; }
th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px; font-weight: 600; color: var(--cyan);
  letter-spacing: 0.05em; text-transform: uppercase;
  text-align: left; padding: 10px 16px;
  background: #0f224088; border-bottom: 1px solid #00d4ff20;
}
td {
  padding: 10px 16px; color: var(--grey);
  border-bottom: 1px solid #00d4ff08; vertical-align: top;
}
td code { font-size: 12px; white-space: nowrap; }

@media (max-width: 768px) {
  .sidebar { transform: translateX(-100%); transition: transform 0.3s; }
  .sidebar.open { transform: translateX(0); }
  .mobile-toggle { display: block; }
  .main { margin-left: 0; padding: 48px 20px 60px; }
  .pkg-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<button class="mobile-toggle" onclick="document.querySelector('.sidebar').classList.toggle('open')">&#9776;</button>

<nav class="sidebar">
  <a href="/" class="sidebar-brand">
    <span class="cyan">Otter</span>Bot
    <span class="sub">Documentation</span>
  </a>
  <a href="/" class="sidebar-back">&larr; Back to Home</a>
  <div class="sidebar-section">Guide</div>
  <a href="/docs/" class="sidebar-link">Overview</a>
  <a href="/docs/getting-started.html" class="sidebar-link">Getting Started</a>
  <a href="/docs/architecture.html" class="sidebar-link active">Architecture</a>
  <a href="/docs/agents.html" class="sidebar-link">Agent System</a>
  <a href="/docs/features.html" class="sidebar-link">Features</a>
  <div class="sidebar-section">Reference</div>
  <a href="/docs/api.html" class="sidebar-link">API Reference</a>
  <div class="sidebar-footer">
    <a href="https://github.com/TOoSmOotH/otterbot">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
      GitHub
    </a>
  </div>
</nav>

<main class="main">
  <h1><span class="cyan">Architecture</span></h1>
  <p class="page-desc">
    How OtterBot is built: the agent hierarchy, message bus, workspace isolation, and the
    technology that ties it all together.
  </p>

  <div class="on-page">
    <div class="on-page-title">On this page</div>
    <a href="#overview">System Overview</a>
    <a href="#hierarchy">Agent Hierarchy</a>
    <a href="#message-bus">Message Bus</a>
    <a href="#workspaces">Workspace Isolation</a>
    <a href="#tech-stack">Tech Stack</a>
    <a href="#packages">Package Structure</a>
  </div>

  <!-- SYSTEM OVERVIEW -->
  <h2 id="overview"><span class="cyan">#</span> System Overview</h2>
  <p>
    OtterBot is a multi-agent AI system that runs inside a single Docker container. A human
    user (the "CEO") gives high-level goals to an AI orchestrator (the "COO"), which delegates
    work through a hierarchy of team leads and workers &mdash; each with their own tools and
    capabilities.
  </p>

  <div class="diagram"><span class="note">                    OtterBot Architecture</span>

<span class="note">  +---------------------------------------------------------+</span>
<span class="note">  |</span>  <span class="role">Browser (React + Three.js)</span>                              <span class="note">|</span>
<span class="note">  |</span>  Chat UI &bull; 3D Live View &bull; Agent Graph &bull; Kanban Board   <span class="note">|</span>
<span class="note">  +---------------------------+-----------------------------+</span>
                              <span class="arrow">|</span>
                     <span class="arrow">Socket.IO + REST</span>
                              <span class="arrow">|</span>
<span class="note">  +---------------------------+-----------------------------+</span>
<span class="note">  |</span>  <span class="role">Server (Fastify + Socket.IO)</span>                            <span class="note">|</span>
<span class="note">  |</span>                                                         <span class="note">|</span>
<span class="note">  |</span>  <span class="fl">CEO</span> <span class="arrow">&rarr;</span> <span class="fl">COO</span> <span class="arrow">&rarr;</span> <span class="fl">Team Leads</span> <span class="arrow">&rarr;</span> <span class="fl">Workers</span>                  <span class="note">|</span>
<span class="note">  |</span>                                                         <span class="note">|</span>
<span class="note">  |</span>  Message Bus &bull; Agent Registry &bull; Tool Context           <span class="note">|</span>
<span class="note">  |</span>  TTS/STT &bull; Search &bull; Browser Pool &bull; Package Mgr       <span class="note">|</span>
<span class="note">  +---------------------------+-----------------------------+</span>
                              <span class="arrow">|</span>
<span class="note">  +---------------------------+-----------------------------+</span>
<span class="note">  |</span>  <span class="role">Storage &amp; Services</span>                                     <span class="note">|</span>
<span class="note">  |</span>  SQLite (encrypted) &bull; Workspace FS &bull; noVNC Desktop     <span class="note">|</span>
<span class="note">  +---------------------------------------------------------+</span></div>

  <!-- AGENT HIERARCHY -->
  <h2 id="hierarchy"><span class="cyan">#</span> Agent Hierarchy</h2>
  <p>
    OtterBot uses a corporate-inspired command chain where each level has distinct
    responsibilities:
  </p>

  <div class="diagram"><span class="role">CEO</span> <span class="note">(Human User)</span>
 <span class="arrow">|</span>
 <span class="arrow">|</span>  Sends high-level goals via chat
 <span class="arrow">|</span>
 <span class="arrow">v</span>
<span class="role">COO</span> <span class="note">(Single persistent AI agent)</span>
 <span class="arrow">|</span>
 <span class="arrow">|</span>  Creates projects, writes charters,
 <span class="arrow">|</span>  delegates to Team Leads
 <span class="arrow">|</span>
 <span class="arrow">v</span>
<span class="role">Team Leads</span> <span class="note">(One per project)</span>
 <span class="arrow">|</span>
 <span class="arrow">|</span>  Break directives into tasks,
 <span class="arrow">|</span>  assign Kanban items, spawn Workers
 <span class="arrow">|</span>
 <span class="arrow">v</span>
<span class="role">Workers</span> <span class="note">(Per-task agents)</span>

   Execute individual tasks using tools:
   file I/O, shell, browser, web search, etc.</div>

  <ul>
    <li><strong>CEO (Human)</strong> &mdash; You. Send goals through the chat interface.</li>
    <li><strong>COO</strong> &mdash; The primary AI agent. Maintains conversation context, creates projects, writes project charters, and delegates work to Team Leads.</li>
    <li><strong>Team Lead</strong> &mdash; Manages a single project. Breaks directives into Kanban tasks, spawns workers, and monitors progress.</li>
    <li><strong>Worker</strong> &mdash; Executes a single task. Has access to tools (file read/write, shell, browser, web search, package installs) based on its template.</li>
  </ul>

  <div class="callout info">
    <span class="icon">&#128218;</span>
    <p>
      <strong>Agent lifecycle:</strong> All agents follow the status cycle
      <code>Idle</code> &rarr; <code>Thinking</code> &rarr; <code>Acting</code> &rarr; <code>Done</code>
      (or <code>Error</code>). See <a href="/docs/agents.html#lifecycle">Agent System &rarr; Lifecycle</a>.
    </p>
  </div>

  <!-- MESSAGE BUS -->
  <h2 id="message-bus"><span class="cyan">#</span> Message Bus</h2>
  <p>
    All agent-to-agent communication flows through a central message bus. Every message is
    persisted to the database and broadcast to connected clients via Socket.IO.
  </p>

  <h3>Message Flow</h3>
  <ul>
    <li>The CEO sends a message via <code>ceo:message</code> Socket.IO event</li>
    <li>The COO receives it, processes with an LLM, and responds via <code>coo:response</code> / <code>coo:stream</code></li>
    <li>If the COO creates a project, it spawns a Team Lead and sends directives via the bus</li>
    <li>Team Leads spawn Workers and assign tasks via bus messages</li>
    <li>Workers report results back up the chain</li>
    <li>All messages are broadcast as <code>bus:message</code> events to the frontend</li>
  </ul>

  <h3>BusMessage Structure</h3>
  <p>Every message on the bus contains:</p>
  <div class="code-block">{
  <span class="str">"id"</span>: <span class="str">"msg_abc123"</span>,
  <span class="str">"fromAgentId"</span>: <span class="str">"coo-main"</span>,
  <span class="str">"toAgentId"</span>: <span class="str">"tl-project-1"</span>,
  <span class="str">"content"</span>: <span class="str">"Implement the login page..."</span>,
  <span class="str">"role"</span>: <span class="str">"assistant"</span>,
  <span class="str">"conversationId"</span>: <span class="str">"conv_xyz"</span>,
  <span class="str">"projectId"</span>: <span class="str">"proj_1"</span>,
  <span class="str">"timestamp"</span>: <span class="str">"2025-01-15T10:30:00Z"</span>
}</div>

  <!-- WORKSPACE ISOLATION -->
  <h2 id="workspaces"><span class="cyan">#</span> Workspace Isolation</h2>
  <p>
    Each agent operates within an isolated workspace directory under the
    <code>WORKSPACE_ROOT</code>. This prevents agents from accidentally interfering with each
    other's files.
  </p>
  <ul>
    <li>The workspace root defaults to <code>./data</code></li>
    <li>Project files are scoped to their project directory</li>
    <li>The database is stored at <code>WORKSPACE_ROOT/otterbot.db</code> and encrypted with <code>OTTERBOT_DB_KEY</code></li>
    <li>AI model caches (TTS/STT) are stored under <code>WORKSPACE_ROOT/data/models</code></li>
    <li>The optional virtual desktop runs in its own X11 session</li>
  </ul>

  <!-- TECH STACK -->
  <h2 id="tech-stack"><span class="cyan">#</span> Tech Stack</h2>

  <h3>Backend</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Technology</th><th>Purpose</th></tr>
      </thead>
      <tbody>
        <tr><td><code>Fastify</code></td><td>HTTP server for REST API</td></tr>
        <tr><td><code>Socket.IO</code></td><td>Real-time bidirectional communication</td></tr>
        <tr><td><code>Vercel AI SDK</code></td><td>Unified LLM interface (Anthropic, OpenAI, compatible providers)</td></tr>
        <tr><td><code>Drizzle ORM</code></td><td>Type-safe database access</td></tr>
        <tr><td><code>better-sqlite3</code></td><td>SQLite with encryption support</td></tr>
        <tr><td><code>Playwright</code></td><td>Browser automation for agents</td></tr>
        <tr><td><code>kokoro-js</code></td><td>Local text-to-speech (Kokoro model)</td></tr>
        <tr><td><code>@huggingface/transformers</code></td><td>Local speech-to-text (Whisper)</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Frontend</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Technology</th><th>Purpose</th></tr>
      </thead>
      <tbody>
        <tr><td><code>React 19</code></td><td>UI framework</td></tr>
        <tr><td><code>Vite</code></td><td>Build tool and dev server</td></tr>
        <tr><td><code>Three.js / R3F</code></td><td>3D agent visualization (Live View)</td></tr>
        <tr><td><code>@xyflow/react</code></td><td>Agent graph visualization</td></tr>
        <tr><td><code>Socket.IO Client</code></td><td>Real-time event handling</td></tr>
      </tbody>
    </table>
  </div>

  <h3>Infrastructure</h3>
  <div class="table-wrap">
    <table>
      <thead>
        <tr><th>Technology</th><th>Purpose</th></tr>
      </thead>
      <tbody>
        <tr><td><code>Docker</code></td><td>Container runtime</td></tr>
        <tr><td><code>XFCE + noVNC</code></td><td>Virtual desktop environment</td></tr>
        <tr><td><code>TypeScript</code></td><td>Language across all packages</td></tr>
        <tr><td><code>pnpm workspaces</code></td><td>Monorepo management</td></tr>
      </tbody>
    </table>
  </div>

  <!-- PACKAGE STRUCTURE -->
  <h2 id="packages"><span class="cyan">#</span> Package Structure</h2>
  <p>
    OtterBot is organized as a monorepo with three pnpm workspace packages:
  </p>

  <div class="pkg-grid">
    <div class="pkg-card">
      <h4>@otterbot/server</h4>
      <div class="path">packages/server/</div>
      <p>
        Main backend: Fastify REST API, Socket.IO handlers, agent orchestration (COO, Team Lead,
        Worker), database, TTS/STT, search, browser pool, tool execution.
      </p>
    </div>
    <div class="pkg-card">
      <h4>@otterbot/web</h4>
      <div class="path">packages/web/</div>
      <p>
        React 19 + Vite frontend: chat interface, 3D Live View (Three.js), agent graph (XYFlow),
        Kanban board, settings panels, room builder.
      </p>
    </div>
    <div class="pkg-card">
      <h4>@otterbot/shared</h4>
      <div class="path">packages/shared/</div>
      <p>
        Shared TypeScript type definitions: Agent, AgentRole, AgentStatus, RegistryEntry,
        Project, KanbanTask, BusMessage, Socket.IO event interfaces.
      </p>
    </div>
  </div>

  <div class="code-block">otterbot/
<span class="fl">+--</span> package.json          <span class="cm"># Root workspace config</span>
<span class="fl">+--</span> packages/
<span class="fl">|  +--</span> server/            <span class="cm"># @otterbot/server</span>
<span class="fl">|  |  +--</span> src/
<span class="fl">|  |  |  +--</span> index.ts     <span class="cm"># Fastify app + routes</span>
<span class="fl">|  |  |  +--</span> agents/      <span class="cm"># COO, Team Lead, Worker, BaseAgent</span>
<span class="fl">|  |  |  +--</span> socket/      <span class="cm"># Socket.IO event handlers</span>
<span class="fl">|  |  |  +--</span> db/          <span class="cm"># Drizzle schema, migrations, seed</span>
<span class="fl">|  |  |  +--</span> tools/       <span class="cm"># Agent tools (file, shell, browse, search)</span>
<span class="fl">|  |  |  +--</span> tts/         <span class="cm"># Text-to-speech providers</span>
<span class="fl">|  |  |  +--</span> stt/         <span class="cm"># Speech-to-text providers</span>
<span class="fl">|  |  |  +--</span> registry/    <span class="cm"># Agent template registry</span>
<span class="fl">|  |  |  +--</span> models3d/    <span class="cm"># 3D model/environment pack discovery</span>
<span class="fl">|  +--</span> web/               <span class="cm"># @otterbot/web</span>
<span class="fl">|  |  +--</span> src/
<span class="fl">|  |  |  +--</span> components/  <span class="cm"># React components</span>
<span class="fl">|  |  |  +--</span> stores/      <span class="cm"># State management</span>
<span class="fl">|  +--</span> shared/            <span class="cm"># @otterbot/shared</span>
<span class="fl">|     +--</span> src/types/     <span class="cm"># TypeScript interfaces &amp; enums</span>
<span class="fl">+--</span> assets/
   <span class="fl">+--</span> workers/           <span class="cm"># 3D character models (GLB)</span>
   <span class="fl">+--</span> environments/      <span class="cm"># 3D environment models (GLTF)</span>
   <span class="fl">+--</span> scenes/            <span class="cm"># Scene configuration JSON</span></div>
</main>

</body>
</html>
